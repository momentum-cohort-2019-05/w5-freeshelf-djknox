# Generated by Django 2.2.2 on 2019-06-24 17:38
from django.db import migrations, models
from django.conf import settings
import os
import csv


def load_data(apps, schema_editor):
    Author = apps.get_model("library", "Author")
    Book = apps.get_model("library", "Book")

    # clear initial authors and books
    Author.objects.all().delete()
    Book.objects.all().delete()

    # set filename
    filename = os.path.join(settings.BASE_DIR, 'sample_books.csv')

    with open(filename) as csv_file:
        # create csv reader object
        reader = csv.reader(csv_file)
        # skip header
        next(reader)

        for row in reader:
            # create the author, avoiding duplicates with get_or_create
            author, created = Author.objects.get_or_create(name=row[1])
            author.save()

            # create the book
            book = Book(
                title = row[0],
                author = author,
                url = row[2],
                description = row[3]
            )
            book.save()


# reverse migration
def reverse_func(apps, schema_editor):
    Author = apps.get_model("library", "Author")
    Book = apps.get_model("library", "Book")

    Author.objects.all().delete()
    Book.objects.all().delete()


class Migration(migrations.Migration):

    dependencies = [
        ('library', '0002_auto_20190624_1709'),
    ]

    operations = [
        migrations.RunPython(load_data, reverse_func)
    ]
